# アプリケーション環境の最低限のコンテナ化(20200412~)
- 開発PCがDocker環境ではないアプリも作っているPCだから、Dockerで入れるrubyのイメージも古いものを入れる必要ある
  - 対応案
    - rbenvをフル活用
    - docker化するまでは古いイメージを使って、やりたいバージョンに変える
- 考えるべきはrubyのバージョンだけでなくbundlerのバージョンも。
  - 発生した問題
    - ローカルや本番環境でruby2.5.3&bundler2.1.2の環境で作業をしちゃっており、Gemfile.lockがbundler2以上を前提とした構成になっている
    - rubyイメージだとbundler1.7.1を使用している。
    - ローカル環境を変えればいいんだけど、それを元にいろんなアプリを立ち上げていたから、変えるのが面倒くさい。しかも古いのに合わせるために変えるのが面倒。どうせrubyんも新しいバージョンを使っていきたいベクトルに載ってるんだから、新しいbundlerが入ってる前提でことを進めたい
  - 対応
    - こんなの工夫次第でなんとかなるんだろうけど、こんなことで頑張りたくないからrubyイメージのデフォルトのバージョンでハックしたい
      - ruby2.5.3だとデフォルトで1.17.1
      - ruby2.6だとデフォルトで1.17.2
      - ruby2.7.1だとデフォルトで2.1.4
        - きたーーーーーーー。ローカルのruby2.5.3＆bundler2.1.2環境で作ったrailsアプリのGemfileのrubyのバージョンを書き換えればいい感じに動いた！ これがあるべき姿かは別としてねじ曲がった思想なしに前に進める
- [Dockerfileの記法](http://docs.docker.jp/engine/reference/builder.html)
  - コマンド実行
    - [RUNとCMDとENTRYPOINT](https://shinkufencer.hateblo.jp/entry/2019/01/28/225553)について
      - Dockerfileはコンテナ作成ではなくイメージ作成のためのファイル
      - イメージ作成時のことを考えるならRUNだけを使う
      - コンテナを作る時用にCMDとENTRYPOINTがある
      - CMDはコンテナ作成時の強制上書きコマンド
  - `WORKDIR /path/to/dir`はコマンド実行設定
  - 変数定義
    - ENVは環境変数、ARGは構築中に使う変数
    - [ARGは文字通り引数で値を指定](https://techblog.recochoku.jp/1979) `docker build -f ./Dockerfile --build-arg MES="Hello" .`
  - Docker実行側のPCとのファイル・ディレクトリ連携 ADD, COPY, VOLUME
    - `VOLUME /path/to/dir`
    - [コピーのADDとCOPY](https://qiita.com/YumaInaura/items/1647e509f83462a37494)
- [ベストプラクティス](https://qiita.com/enta0701/items/b872eef6d910908c0e6c)
  - `docker exec -it`
    - `-i`：コンテナ内の標準出力とホスト側の出力をつなげる
    - `-t`：ホスト側の入力をコンテナの標準出力につなげる
- docker-composeコマンド使いたい
  - 1イメージの場合不要だけど、`docker run`コマンドにいろんな引数つけるの面倒。
  - 固定した環境でコンテナ起動したいからdocker-composeコマンドを使う
  - 当たり前だけどごっちゃにしてたこと。Dockerfileはイメージ作成、.docker-compose.ymlはコンテナ作成のためのファイル、entrypointファイルはコンテナ作成時にアプリケーション起動するファイル。
  - ↑この定義は間違ってないけど、docker-compose.ymlでDockerfile自体も指定してbuildもやってくれる模様
  - 使いたいオプションは以下連携
    - ポート
    - プロジェクトディレクトリ
      - rubyイメージを取るとrailsにbundler2以上を求められ、それを前提にGemfile.lockが作られているが、イメージではbundler1.17.1入れていて上書きできなくて、デフォルトのGemfile.lockじゃ対処できないからどうしようかな。
- ホスト側から3000ポート（または3001ポート）にアクセスできないorz
  - docker-compose.ymlのportsで3000:3000を指定しているにも関わらず
  - そもそも開く設定を明示的にしなきゃいけないのかと思い、DockerfileでEXPOSEコマンドで開けてみたけど効果なし
  - `rails s -p $port -b "0.0.0.0"`と-bをつけたらなんかうまくいった！